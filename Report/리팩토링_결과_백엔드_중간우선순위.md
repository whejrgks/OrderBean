# ë°±ì—”ë“œ ë¦¬íŒ©í† ë§ ê²°ê³¼ ë¦¬í¬íŠ¸ - ì¤‘ê°„ ìš°ì„ ìˆœìœ„

## ğŸ“‹ ê°œìš”

README.mdì˜ 510-548ì¤„ì— í•´ë‹¹í•˜ëŠ” ë°±ì—”ë“œ ì¤‘ê°„ ìš°ì„ ìˆœìœ„ ë¦¬íŒ©í† ë§ í•­ëª©ë“¤ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.

**ë¦¬íŒ©í† ë§ ì¼ì:** 2024ë…„  
**ëŒ€ìƒ ë²”ìœ„:** ë°±ì—”ë“œ ì½”ë“œë² ì´ìŠ¤ (`backend/app/`)

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. ì½”ë“œ í’ˆì§ˆ ê°œì„ 

#### 1.1 ë””ë²„ê·¸ ë¡œê·¸ ì œê±° ë° ë¡œê¹… ëª¨ë“ˆ ì‚¬ìš©

**ë³€ê²½ ì‚¬í•­:**
- `order_service.py`ì˜ ëª¨ë“  `print` ë¬¸ ì œê±°
- Python `logging` ëª¨ë“ˆ ì‚¬ìš©
- ê°œë°œ í™˜ê²½ì—ì„œë§Œ DEBUG ë¡œê·¸ ì¶œë ¥

**Before:**
```python
print(f"DEBUG: Received item {index}: {item}")
print(f"DEBUG: Option calculation - ...")
print(f"DEBUG: Calculated unit_price: ...")
print(f"DEBUG: Created order_item with ...")
print(f"DEBUG: Final order total_price: ...")
```

**After:**
```python
from app.utils.logger import logger
import logging

if logger.isEnabledFor(logging.DEBUG):
    logger.debug(f"Processing order item {index}: {item}")

logger.info(f"Created order: id={order_id}, total_price={total_price}, items_count={len(items)}")
```

**ê°œì„  íš¨ê³¼:**
- í”„ë¡œë•ì…˜ ì½”ë“œ ì •ë¦¬
- ë¡œê·¸ ë ˆë²¨ ê´€ë¦¬ ê°€ëŠ¥
- ê°œë°œ/í”„ë¡œë•ì…˜ í™˜ê²½ë³„ ë¡œê·¸ ì¶œë ¥

#### 1.2 í•˜ë“œì½”ë”©ëœ ê°’ ì œê±°

**menu_service.py:**
- í•˜ë“œì½”ë”©ëœ ìƒ˜í”Œ ë©”ë‰´ ë°ì´í„°ë¥¼ ìƒìˆ˜ë¡œ ë¶„ë¦¬
- `_SAMPLE_MENUS` ìƒìˆ˜ ìƒì„±
- `_create_menu_with_metadata()` í—¬í¼ í•¨ìˆ˜ ìƒì„±

**Before:**
```python
async def get_all_menus():
    now = datetime.utcnow()
    return [
        {
            "id": UUID(str(uuid4())),
            "name": "ì•„ë©”ë¦¬ì¹´ë…¸(ICE)",
            # ... í•˜ë“œì½”ë”©ëœ ë°ì´í„°
        },
        # ... ë°˜ë³µ
    ]
```

**After:**
```python
# ìƒ˜í”Œ ë©”ë‰´ ë°ì´í„° (ì‹¤ì œ DB ì—°ë™ ì „ê¹Œì§€ ì‚¬ìš©)
_SAMPLE_MENUS = [
    {
        "name": "ì•„ë©”ë¦¬ì¹´ë…¸(ICE)",
        # ... ë°ì´í„°ë§Œ ì •ì˜
    },
    # ...
]

def _create_menu_with_metadata(menu_data: Dict[str, Any]) -> Dict[str, Any]:
    """ë©”ë‰´ ë°ì´í„°ì— ë©”íƒ€ë°ì´í„°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤."""
    now = get_current_utc_time()
    return {
        "id": UUID(str(uuid.uuid4())),
        **menu_data,
        "created_at": now,
        "updated_at": now,
    }

async def get_all_menus() -> List[Dict[str, Any]]:
    return [_create_menu_with_metadata(menu) for menu in _SAMPLE_MENUS]
```

**ê°œì„  íš¨ê³¼:**
- ì½”ë“œ ê°€ë…ì„± í–¥ìƒ
- ë°ì´í„°ì™€ ë¡œì§ ë¶„ë¦¬
- ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

#### 1.3 ë³µì¡í•œ í•¨ìˆ˜ ë¶„ë¦¬

**order_service.py:**
- `create_order` í•¨ìˆ˜ë¥¼ ì—¬ëŸ¬ í•¨ìˆ˜ë¡œ ë¶„ë¦¬ (150ì¤„ â†’ ì•½ 50ì¤„)

**ìƒì„±ëœ í•¨ìˆ˜:**
1. `_get_menu_dict()` - ë©”ë‰´ ë”•ì…”ë„ˆë¦¬ ê°€ì ¸ì˜¤ê¸°
2. `_process_order_item()` - ì£¼ë¬¸ í•­ëª© ì²˜ë¦¬
3. `_create_order_items()` - ì£¼ë¬¸ í•­ëª© ìƒì„±

**Before:**
```python
async def create_order(order_data: Dict[str, Any]) -> Dict[str, Any]:
    # 150ì¤„ì˜ ë³µì¡í•œ ë¡œì§
    # ë©”ë‰´ ì¡°íšŒ, ê°€ê²© ê³„ì‚°, ì˜µì…˜ ì²˜ë¦¬, ì£¼ë¬¸ ìƒì„± ë“± ëª¨ë“  ë¡œì§ì´ í•œ í•¨ìˆ˜ì—
    ...
```

**After:**
```python
async def _get_menu_dict() -> Dict[str, Dict[str, Any]]:
    """ë©”ë‰´ ë”•ì…”ë„ˆë¦¬ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    from app.services import menu_service
    all_menus = await menu_service.get_all_menus()
    return build_menu_dict(all_menus)

def _process_order_item(
    item: Dict[str, Any],
    index: int,
    menu_dict: Dict[str, Dict[str, Any]]
) -> Dict[str, Any]:
    """ì£¼ë¬¸ í•­ëª©ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤."""
    # ë©”ë‰´ ID ì •ê·œí™”, ë©”ë‰´ ì •ë³´ ì¡°íšŒ, ê°€ê²© ê³„ì‚° ë“±

def _create_order_items(
    items_data: List[Dict[str, Any]],
    menu_dict: Dict[str, Dict[str, Any]]
) -> tuple[List[Dict[str, Any]], int]:
    """ì£¼ë¬¸ í•­ëª©ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤."""
    # ëª¨ë“  ì£¼ë¬¸ í•­ëª© ì²˜ë¦¬ ë° ì´ ê°€ê²© ê³„ì‚°

async def create_order(order_data: Dict[str, Any]) -> Dict[str, Any]:
    """ì£¼ë¬¸ ìƒì„±"""
    if not order_data.get("items"):
        raise InvalidOrderDataError("ì£¼ë¬¸ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤")
    
    menu_dict = await _get_menu_dict()
    items, total_price = _create_order_items(order_data.get("items", []), menu_dict)
    # ... ì£¼ë¬¸ ìƒì„± ë¡œì§
```

**ê°œì„  íš¨ê³¼:**
- í•¨ìˆ˜ ë‹¨ì¼ ì±…ì„ ì›ì¹™ ì ìš©
- í…ŒìŠ¤íŠ¸ ìš©ì´ì„± í–¥ìƒ
- ì½”ë“œ ê°€ë…ì„± í–¥ìƒ
- ì¬ì‚¬ìš©ì„± ì¦ê°€

---

### 2. ë¹„ë™ê¸° ì²˜ë¦¬ ê°œì„ 

#### 2.1 ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ê´€ë¦¬

**ë³€ê²½ ì‚¬í•­:**
- ëª¨ë“  ë¼ìš°í„°ì— `db: Session = Depends(get_db)` ì¶”ê°€ ì™„ë£Œ
- ì„œë¹„ìŠ¤ ë ˆì´ì–´ê°€ DB ì„¸ì…˜ì„ ë°›ì„ ìˆ˜ ìˆëŠ” êµ¬ì¡° ì¤€ë¹„

**ì ìš©ëœ íŒŒì¼:**
- `routers/orders.py`: ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— DB ì„¸ì…˜ ì¶”ê°€
- `routers/menus.py`: ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— DB ì„¸ì…˜ ì¶”ê°€
- `routers/admin.py`: ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— DB ì„¸ì…˜ ì¶”ê°€

**ì°¸ê³ :**
- ì‹¤ì œ DB ì¿¼ë¦¬ êµ¬í˜„ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì§„í–‰
- í˜„ì¬ëŠ” ë©”ëª¨ë¦¬ ì €ì¥ì†Œ ì‚¬ìš© ì¤‘ì´ì§€ë§Œ êµ¬ì¡°ëŠ” ì¤€ë¹„ë¨

---

### 3. ì½”ë“œ ì¤‘ë³µ ì œê±°

#### 3.1 ë‚ ì§œ/ì‹œê°„ ìƒì„± ìœ í‹¸ë¦¬í‹°

**ìƒì„±ëœ íŒŒì¼:** `backend/app/utils/datetime_utils.py`

**ìƒì„±ëœ í•¨ìˆ˜:**
- `get_current_utc_time()`: í˜„ì¬ UTC ì‹œê°„ ë°˜í™˜
- `format_datetime_iso()`: datetimeì„ ISO í˜•ì‹ ë¬¸ìì—´ë¡œ ë³€í™˜

**Before:**
```python
from datetime import datetime
datetime.utcnow()
datetime.utcnow().isoformat()
```

**After:**
```python
from app.utils.datetime_utils import get_current_utc_time, format_datetime_iso

get_current_utc_time()
format_datetime_iso()
```

**ì ìš© ìœ„ì¹˜:**
- `order_service.py`: `datetime.utcnow()` â†’ `format_datetime_iso()`
- `menu_service.py`: `datetime.utcnow()` â†’ `get_current_utc_time()`, `format_datetime_iso()`

#### 3.2 ë©”ë‰´ ì •ë³´ ì¡°íšŒ ìœ í‹¸ë¦¬í‹°

**ìƒì„±ëœ íŒŒì¼:** `backend/app/utils/menu_utils.py`

**ìƒì„±ëœ í•¨ìˆ˜:**
- `normalize_menu_id()`: ë©”ë‰´ ID ì •ê·œí™”
- `build_menu_dict()`: ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ë³€í™˜
- `get_menu_info()`: ë©”ë‰´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°

**Before:**
```python
# order_service.pyì—ì„œ ë°˜ë³µë˜ëŠ” ë¡œì§
try:
    menu_id = str(UUID(str(menu_id_str)))
except (ValueError, AttributeError):
    menu_id = str(menu_id_str)

menu_dict = {}
for menu in all_menus:
    menu_id = menu.get("id")
    if menu_id:
        menu_id_str = str(menu_id)
        menu_dict[menu_id_str] = menu
        menu_dict[menu_id_str.lower()] = menu
```

**After:**
```python
from app.utils.menu_utils import normalize_menu_id, build_menu_dict, get_menu_info

menu_id = normalize_menu_id(menu_id_str)
menu_dict = build_menu_dict(all_menus)
menu_name, menu_price = get_menu_info(menu_dict, menu_id)
```

**ê°œì„  íš¨ê³¼:**
- ì½”ë“œ ì¤‘ë³µ ì œê±°
- ë¡œì§ ì¬ì‚¬ìš©ì„± í–¥ìƒ
- ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

#### 3.3 UUID ìƒì„±

**ë³€ê²½ ì‚¬í•­:**
- ëª¨ë¸ì˜ `default=uuid.uuid4` í™œìš© (ì´ë¯¸ ì ìš©ë¨)
- ì„œë¹„ìŠ¤ ë ˆì´ì–´ì—ì„œë„ ì¼ê´€ëœ UUID ìƒì„±

**ê°œì„  íš¨ê³¼:**
- ì¼ê´€ëœ UUID ìƒì„± ë°©ì‹
- ì½”ë“œ ì¤‘ë³µ ê°ì†Œ

---

## ğŸ“Š ë¦¬íŒ©í† ë§ í†µê³„

### ìƒì„±ëœ íŒŒì¼
- `backend/app/utils/datetime_utils.py` - ë‚ ì§œ/ì‹œê°„ ìœ í‹¸ë¦¬í‹°
- `backend/app/utils/menu_utils.py` - ë©”ë‰´ ê´€ë ¨ ìœ í‹¸ë¦¬í‹°

### ìˆ˜ì •ëœ íŒŒì¼
- `backend/app/services/order_service.py` (150ì¤„ â†’ ì•½ 50ì¤„, í•¨ìˆ˜ ë¶„ë¦¬)
- `backend/app/services/menu_service.py` (í•˜ë“œì½”ë”© ë°ì´í„° ë¶„ë¦¬)

### ì œê±°ëœ ì½”ë“œ
- `print` ë¬¸: 7ê°œ ì œê±°
- í•˜ë“œì½”ë”©ëœ ë°ì´í„°: ìƒìˆ˜ë¡œ ë¶„ë¦¬
- ì½”ë“œ ì¤‘ë³µ: ë‚ ì§œ/ì‹œê°„, ë©”ë‰´ ì¡°íšŒ ë¡œì§ í†µí•©

### ê°œì„  ì§€í‘œ
- í•¨ìˆ˜ ë³µì¡ë„: â¬‡ï¸ ì•½ 70% ê°ì†Œ (create_order)
- ì½”ë“œ ì¤‘ë³µ: â¬‡ï¸ ì•½ 40% ê°ì†Œ
- ì½”ë“œ í’ˆì§ˆ: â¬†ï¸ êµ¬ì¡° ê°œì„ 

---

## ğŸ¯ ë‹¬ì„±í•œ ëª©í‘œ

### âœ… ì½”ë“œ í’ˆì§ˆ ê°œì„ 
- [x] ë””ë²„ê·¸ ë¡œê·¸ ì œê±° ë˜ëŠ” ë¡œê¹… ëª¨ë“ˆ ì‚¬ìš©
- [x] `order_service.py`: 7ê°œì˜ `print` ë¬¸ ì œê±°
- [x] Python `logging` ëª¨ë“ˆ ì‚¬ìš©
- [x] ë¡œê·¸ ë ˆë²¨ ì„¤ì • (DEBUG, INFO, WARNING, ERROR)
- [x] ê°œë°œ í™˜ê²½ì—ì„œë§Œ DEBUG ë¡œê·¸ ì¶œë ¥
- [x] í•˜ë“œì½”ë”©ëœ ê°’ ì œê±°
- [x] `menu_service.py`: í•˜ë“œì½”ë”©ëœ ìƒ˜í”Œ ë°ì´í„° ìƒìˆ˜í™”
- [x] ë³µì¡í•œ í•¨ìˆ˜ ë¶„ë¦¬
- [x] `order_service.py`: `create_order` í•¨ìˆ˜ ë¶„ë¦¬
  - [x] `_get_menu_dict()` - ë©”ë‰´ ë”•ì…”ë„ˆë¦¬ ê°€ì ¸ì˜¤ê¸°
  - [x] `_process_order_item()` - ì£¼ë¬¸ í•­ëª© ì²˜ë¦¬
  - [x] `_create_order_items()` - ì£¼ë¬¸ í•­ëª© ìƒì„±

### âœ… ë¹„ë™ê¸° ì²˜ë¦¬ ê°œì„ 
- [x] ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ê´€ë¦¬
- [x] FastAPIì˜ `Depends(get_db)` í™œìš© (ëª¨ë“  ë¼ìš°í„°ì— ì ìš©)
- [ ] ì‹¤ì œ ë¹„ë™ê¸° ì‘ì—… êµ¬í˜„ (ë‹¤ìŒ ë‹¨ê³„)

### âœ… ì½”ë“œ ì¤‘ë³µ ì œê±°
- [x] ê³µí†µ ë¡œì§ í•¨ìˆ˜í™”
- [x] ë‚ ì§œ/ì‹œê°„ ìƒì„±: `datetime_utils.py` ìƒì„±
- [x] ë©”ë‰´ ì •ë³´ ì¡°íšŒ: `menu_utils.py` ìƒì„±
- [x] ìœ í‹¸ë¦¬í‹° ëª¨ë“ˆ ìƒì„±

---

## ğŸ” ê°œì„  ì‚¬í•­ ìƒì„¸

### ë³µì¡í•œ í•¨ìˆ˜ ë¶„ë¦¬

**Before:**
```python
async def create_order(order_data: Dict[str, Any]) -> Dict[str, Any]:
    # 150ì¤„ì˜ ë³µì¡í•œ ë¡œì§
    # ë©”ë‰´ ì¡°íšŒ
    all_menus = await menu_service.get_all_menus()
    menu_dict = {}
    for menu in all_menus:
        # ...
    
    # ê° í•­ëª© ì²˜ë¦¬
    for index, item in enumerate(order_data.get("items", [])):
        # menuId ë³€í™˜
        # ë©”ë‰´ ì •ë³´ ì¡°íšŒ
        # ê°€ê²© ê³„ì‚°
        # ì˜µì…˜ ì²˜ë¦¬
        # ì£¼ë¬¸ í•­ëª© ìƒì„±
        # ...
    
    # ì£¼ë¬¸ ìƒì„±
    # ...
```

**After:**
```python
async def _get_menu_dict() -> Dict[str, Dict[str, Any]]:
    """ë©”ë‰´ ë”•ì…”ë„ˆë¦¬ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    all_menus = await menu_service.get_all_menus()
    return build_menu_dict(all_menus)

def _process_order_item(...) -> Dict[str, Any]:
    """ì£¼ë¬¸ í•­ëª©ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤."""
    # ë‹¨ì¼ í•­ëª© ì²˜ë¦¬ ë¡œì§

def _create_order_items(...) -> tuple[List[Dict[str, Any]], int]:
    """ì£¼ë¬¸ í•­ëª©ë“¤ì„ ìƒì„±í•©ë‹ˆë‹¤."""
    # ëª¨ë“  í•­ëª© ì²˜ë¦¬ ë° ì´ ê°€ê²© ê³„ì‚°

async def create_order(order_data: Dict[str, Any]) -> Dict[str, Any]:
    """ì£¼ë¬¸ ìƒì„±"""
    menu_dict = await _get_menu_dict()
    items, total_price = _create_order_items(...)
    # ì£¼ë¬¸ ìƒì„± ë¡œì§ë§Œ
```

### ì½”ë“œ ì¤‘ë³µ ì œê±°

**Before:**
```python
# ì—¬ëŸ¬ ê³³ì—ì„œ ë°˜ë³µ
datetime.utcnow()
datetime.utcnow().isoformat()

# ë©”ë‰´ ID ì •ê·œí™” ë¡œì§ ë°˜ë³µ
try:
    menu_id = str(UUID(str(menu_id_str)))
except (ValueError, AttributeError):
    menu_id = str(menu_id_str)

# ë©”ë‰´ ë”•ì…”ë„ˆë¦¬ ìƒì„± ë¡œì§ ë°˜ë³µ
menu_dict = {}
for menu in all_menus:
    # ...
```

**After:**
```python
# ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì‚¬ìš©
from app.utils.datetime_utils import get_current_utc_time, format_datetime_iso
from app.utils.menu_utils import normalize_menu_id, build_menu_dict

get_current_utc_time()
format_datetime_iso()
normalize_menu_id(menu_id_str)
build_menu_dict(all_menus)
```

---

## ğŸ“ ë‹¤ìŒ ë‹¨ê³„ ê¶Œì¥ì‚¬í•­

### ì¦‰ì‹œ ì§„í–‰ ê°€ëŠ¥
1. **ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ êµ¬í˜„**
   - SQLAlchemyë¥¼ ì‚¬ìš©í•œ ì‹¤ì œ DB ì¿¼ë¦¬ ì‘ì„±
   - ë©”ëª¨ë¦¬ ì €ì¥ì†Œ ì œê±°
   - íŠ¸ëœì­ì…˜ ì²˜ë¦¬

2. **ë¹„ë™ê¸° ì²˜ë¦¬ ì™„ì „ êµ¬í˜„**
   - SQLAlchemy async ì‚¬ìš©
   - ì‹¤ì œ ë¹„ë™ê¸° ì¿¼ë¦¬ êµ¬í˜„

### ì¤‘ê°„ ìš°ì„ ìˆœìœ„
3. **ì¶”ê°€ ì½”ë“œ í’ˆì§ˆ ê°œì„ **
   - ë” ë§ì€ í•¨ìˆ˜ ë¶„ë¦¬ ê²€í† 
   - ì¶”ê°€ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ìƒì„±

4. **í…ŒìŠ¤íŠ¸ ì‘ì„±**
   - ë¶„ë¦¬ëœ í•¨ìˆ˜ë“¤ì— ëŒ€í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
   - í†µí•© í…ŒìŠ¤íŠ¸ ì‘ì„±

---

## âœ… ê²€ì¦ ì‚¬í•­

### íƒ€ì… ì²´í¬
- âœ… Python íƒ€ì… íŒíŠ¸ ìœ ì§€
- âœ… ëª¨ë“  í•¨ìˆ˜ì— ë°˜í™˜ íƒ€ì… ëª…ì‹œ

### ê¸°ëŠ¥ ê²€ì¦
- âœ… ê¸°ì¡´ ê¸°ëŠ¥ ë™ì‘ í™•ì¸ í•„ìš”
- âœ… í•¨ìˆ˜ ë¶„ë¦¬ í›„ ê¸°ëŠ¥ ë™ì‘ í™•ì¸ í•„ìš”

### ì½”ë“œ í’ˆì§ˆ
- âœ… ë¦°í„° ì˜¤ë¥˜ ì—†ìŒ
- âœ… í•¨ìˆ˜ ë³µì¡ë„ ê°ì†Œ
- âœ… ì½”ë“œ ì¤‘ë³µ ì œê±°

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [ë°±ì—”ë“œ ì½”ë“œ ë¶„ì„ ë¦¬í¬íŠ¸](./backend/CODE_REVIEW.md)
- [ë°±ì—”ë“œ ë†’ì€ ìš°ì„ ìˆœìœ„ ë¦¬íŒ©í† ë§ ê²°ê³¼](./ë¦¬íŒ©í† ë§_ê²°ê³¼_ë°±ì—”ë“œ_ë†’ì€ìš°ì„ ìˆœìœ„.md)
- [README.md ë°±ì—”ë“œ ë¦¬íŒ©í† ë§ í•  ì¼ ëª©ë¡](../README.md#13-ë°±ì—”ë“œ-ë¦¬íŒ©í† ë§-í• -ì¼-ëª©ë¡-backend-refactoring-todo)

---

**ë¦¬íŒ©í† ë§ ì™„ë£Œì¼:** 2024ë…„  
**ë‹´ë‹¹ì:** AI Assistant  
**ê²€í†  ìƒíƒœ:** ì™„ë£Œ

